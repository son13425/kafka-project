import threading
import uvicorn

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import ORJSONResponse

from api.routers import main_router
from core.config import settings, logger
from kafka_client.producer import init_producer, get_producer
from kafka_client.producer_plain import init_plain_producer, get_plain_producer
from kafka_client.consumers import run_consumers
from kafka_client.schemas import json_schema_str


app = FastAPI(
    title=settings.name,
    default_response_class=ORJSONResponse,
    docs_url='/api/openapi',
    openapi_url='/api/openapi.json'
)


app.include_router(main_router, prefix='/api')


app.add_middleware(
    CORSMiddleware,
    allow_origins=['*'],
    allow_credentials=True,
    allow_methods=['GET', 'POST', 'OPTIONS'],
    allow_headers=[
        'Content-Type',
        'Access-Control-Allow-Headers',
        'Access-Control-Allow-Origin'
    ],
)


app.state.kafka_consumers = None


@app.on_event('startup')
async def startup_event():
    """Запуск сервиса Кафка."""
    logger.info('Запуск Kafka')
    try:
        # Инициализация продюсера с передачей URL Schema Registry
        init_producer(
            bootstrap_servers=settings.kafka_bootstrap_servers,
            topic=settings.kafka_topic,
            schema_registry_url=settings.kafka_schemaregistry_url
        )
        logger.info('Kafka продюсер инициализирован')
    except Exception as e:
        logger.error('Ошибка инициализации продюсера: %s', e)

    try:
        # Инициализация простого продюсера
        init_plain_producer(
            bootstrap_servers=settings.kafka_bootstrap_servers
        )
        logger.info('Kafka продюсер инициализирован')
    except Exception as e:
        logger.error('Ошибка инициализации продюсера: %s', e)

    # Запуск консьюмеров
    try:
        consumers_info = run_consumers(
            bootstrap_servers=settings.kafka_bootstrap_servers,
            topic=settings.kafka_topic,
            single_group_id=settings.single_consumer_group_id,
            batch_group_id=settings.batch_consumer_group_id,
            schema_registry_url=settings.kafka_schemaregistry_url,
            schema_str=json_schema_str
        )

        # Сохраняем информацию о консьюмерах для возможного graceful shutdown
        app.state.kafka_consumers = consumers_info
        logger.info('Kafka консьюмеры успешно запущены')
    except Exception as e:
        logger.error('Ошибка запуска консьюмеров: %s', e)


@app.on_event('shutdown')
async def shutdown_event():
    """Остановка сервиса Кафка."""
    logger.info('Завершение приложения Kafka')
    # Закрываем продюсер
    producer = get_producer()
    if producer:
        try:
            producer.close()
            logger.info('Kafka продюсер закрыт')
        except Exception as e:
            logger.error('Ошибка закрытия продюсера: %s', e)
    plain_producer = get_plain_producer()
    if plain_producer:
        try:
            plain_producer.close()
            logger.info('Простой Kafka продюсер закрыт')
        except Exception as e:
            logger.error('Ошибка закрытия простого продюсера: %s', e)
    # Фиксируем остановку консьюмеров
    if app.state.kafka_consumers:
        logger.info('Консьюмеры завершают работу')


if __name__ == '__main__':
    uvicorn.run(
        'main:app',
        host=settings.host,
        port=settings.port,
        reload=True
    )
